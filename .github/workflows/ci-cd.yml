name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop, by-claude-4.1-opus ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ğŸ” Code Quality Checks
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip pip-tools
        pip install -e ".[dev]"

    - name: ğŸ–¤ Code Formatting (Black)
      run: black --check --diff .

    - name: ğŸ“Š Import Sorting (isort)
      run: isort --check-only --diff .

    - name: ğŸ” Linting (Flake8)
      run: flake8 .

    - name: ğŸ·ï¸ Type Checking (MyPy)
      run: mypy src/duoformer --show-error-codes --pretty || true
      # Note: Using '|| true' to not fail on type errors initially

    - name: ğŸ”’ Security Scan (Bandit)
      run: bandit -r src/duoformer -f json -o bandit-report.json || true

    - name: ğŸ“¤ Upload Security Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-report
        path: bandit-report.json

  # ğŸ§ª Unit Tests (Multi-platform, Multi-version)
  test:
    name: ğŸ§ª Tests (Python ${{ matrix.python-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸ§ª Run Unit Tests
      run: |
        pytest tests/unit/ -v --tb=short --cov=src/duoformer --cov-report=xml --cov-report=term

    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  # ğŸš€ Integration Tests
  integration:
    name: ğŸš€ Integration Tests
    runs-on: ubuntu-latest
    needs: [quality, test]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸ”§ Run Integration Tests
      run: |
        pytest tests/integration/ -v --tb=short -x

    - name: ğŸ¥ Health Check
      run: |
        python tools/testing/health_check.py --verbose || true

    - name: ğŸ” System Check
      run: |
        python tools/testing/check_system.py || true

  # ğŸ³ Docker Build Test
  docker:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [quality]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”¨ Build Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.jupyter
        push: false
        tags: duoformer:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ§ª Test Docker Container
      run: |
        docker run --rm duoformer:test python -c "
        import sys
        import torch
        print('âœ… Docker container works!')
        print(f'Python: {sys.version_info.major}.{sys.version_info.minor}')
        print(f'PyTorch: {torch.__version__}')
        print(f'CUDA available: {torch.cuda.is_available()}')
        "

  # ğŸ‰ Success Notification
  success:
    name: ğŸ‰ All Checks Passed
    runs-on: ubuntu-latest
    needs: [quality, test, integration, docker]
    if: always()

    steps:
    - name: ğŸ‰ Success
      if: ${{ needs.quality.result == 'success' && needs.test.result == 'success' && needs.integration.result == 'success' && needs.docker.result == 'success' }}
      run: |
        echo "ğŸ‰ All CI checks passed successfully!"
        echo "âœ… Code Quality: ${{ needs.quality.result }}"
        echo "âœ… Tests: ${{ needs.test.result }}"
        echo "âœ… Integration: ${{ needs.integration.result }}"
        echo "âœ… Docker: ${{ needs.docker.result }}"

    - name: âŒ Failure
      if: ${{ needs.quality.result == 'failure' || needs.test.result == 'failure' || needs.integration.result == 'failure' || needs.docker.result == 'failure' }}
      run: |
        echo "âŒ Some CI checks failed:"
        echo "Code Quality: ${{ needs.quality.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Integration: ${{ needs.integration.result }}"
        echo "Docker: ${{ needs.docker.result }}"
        exit 1

